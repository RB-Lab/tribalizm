---
- hosts: bot
  vars:
    registry: '{{ lookup("env", "REGISTRY") }}'
    version: '{{ lookup("env", "npm_package_version") }}'
    # 5000 - dev, 5100 - beta, 5200 - stag, 5555 - prod
    tribalizm_port: '5200'
    network: 'rb-lab'

  tasks:
    # - name: '--- Debug ---'
    #   tags: [debug]
    #   debug:
    #     msg: 'Vars: registry: {{ registry }}; version: {{ version }}; tribalizm_port: {{ tribalizm_port }};  network: {{ network }};'

    - name: Deploy MongoDB
      docker_container:
        name: mongodb
        image: mongo:5.0.4-focal
        volumes:
          - mongo-data:/data/db
        networks:
          - name: '{{ network }}'
        restart_policy: always
        env:
          MONGO_INITDB_ROOT_USERNAME: '{{ db_user | string}}'
          MONGO_INITDB_ROOT_PASSWORD: '{{ db_pass | string}}'
        log_driver: loki
        log_options:
          loki-url: 'http://localhost:3100/loki/api/v1/push'
          loki-retries: '5'
          loki-batch-size: '400'
        # to get rid of warnings:
        container_default_behavior: no_defaults
        network_mode: '{{ network }}'

    - name: install AWS ECR credentials helper
      become: yes
      apt:
        name:
          - amazon-ecr-credential-helper
          - awscli
        update_cache: yes

    - name: Log in to AWS ECR
      shell: aws ecr get-login-password --region eu-central-1 | docker login --username AWS --password-stdin '{{ registry | string }}'

    - name: Deploy Tribalizm bot
      docker_container:
        name: tribalizm-bot
        image: '{{ registry | string }}/tribalizm-bot:{{ version | string }}'
        networks:
          - name: '{{ network }}'
        ports:
          - '{{ tribalizm_port | string }}:3000'
        restart_policy: always
        env:
          DB_HOST: mongodb # name of container from 'Deploy MongoDB' task
          DB_USER: '{{ db_user | string}}'
          DB_PASS: '{{ db_pass | string}}'
          BOT_TOKEN: '{{ bot_token | string}}'
          LOG_LEVEL: 'trace'
        log_driver: loki
        log_options:
          loki-url: 'http://localhost:3100/loki/api/v1/push'
          loki-retries: '5'
          loki-batch-size: '400'
        # to get rid of warnings:
        container_default_behavior: no_defaults
        network_mode: '{{ network }}'

    - name: Set Cron job to check tasks queue
      cron:
        name: check tasks queue
        job: 'curl localhost:{{ tribalizm_port | string }}/check-queue > /dev/null'

    - name: Pull Tribalizm Admin image
      docker_image:
        name: '{{ registry | string }}/tribalizm-admin:{{ version | string }}'
        source: pull
